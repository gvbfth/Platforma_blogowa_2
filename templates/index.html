<!DOCTYPE html>
<html>
<head>
    <title>Blog Platform</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; max-width: 800px; margin: 40px auto; padding: 20px; }
        .post { border: 1px solid #ddd; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .comment { background: #f9f9f9; padding: 10px; margin: 10px 0; border-left: 3px solid #ccc; }
        .comment-form { margin-top: 15px; }
        .comment-form textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 4px; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 4px; }
        input, textarea { width: 100%; margin: 5px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .auth { display: flex; gap: 20px; margin-bottom: 30px; }
        .auth > div { flex: 1; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
        h1 { color: #333; }
        h3 { color: #555; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h5 { color: #777; margin-top: 15px; }
    </style>
</head>
<body>
    <h1> Blog Platform</h1>
    
    <!-- Komunikaty -->
    <div id="message"></div>
    
    <!-- Sekcja autoryzacji -->
    <div class="auth">
        <!-- Rejestracja -->
        <div>
            <h3>Rejestracja</h3>
            <input id="reg_username" placeholder="Nazwa u偶ytkownika (min. 3 znaki)" />
            <input id="reg_email" placeholder="Email" />
            <input id="reg_password" type="password" placeholder="Haso (min. 8 znak贸w)" />
            <button onclick="register()">Zarejestruj si</button>
            <div id="reg_errors" class="error"></div>
        </div>
        
        <!-- Logowanie -->
        <div>
            <h3>Logowanie</h3>
            <input id="login_username" placeholder="Nazwa u偶ytkownika" />
            <input id="login_password" type="password" placeholder="Haso" />
            <button onclick="login()">Zaloguj si</button>
            <button onclick="logout()" id="logoutBtn" style="display:none; background:#dc3545">Wyloguj</button>
            <div id="login_errors" class="error"></div>
            <div id="user_info"></div>
        </div>
    </div>
    
    <hr>
    
    <!-- Tworzenie posta (tylko dla zalogowanych) -->
    <div id="create_post" style="display:none">
        <h3>Nowy post</h3>
        <input id="post_title" placeholder="Tytu (min. 3 znaki)" />
        <textarea id="post_content" placeholder="Tre posta (min. 10 znak贸w)" rows="4"></textarea>
        <button onclick="createPost()">Opublikuj post</button>
    </div>
    
    <!-- Lista post贸w -->
    <div id="posts"></div>
    
    <script>
        let currentUser = null;
        
        // Sprawd藕 status autoryzacji przy starcie
        checkAuthStatus();
        
        // Funkcje API
        
        //async function apiRequest(url, method, data) {
          //  const headers = {
            //    'Content-Type': 'application/json'
            //};
            
            //try {
              //  const response = await fetch(url, {
                //    method,
                  //  headers,
                    //body: data ? JSON.stringify(data) : null,
                    //credentials: 'include'  // WA呕NE: wysya cookies z 偶daniem
                //});
                
                // Logowanie bd贸w
                //if (!response.ok) {
                  //  console.error(`API Error ${response.status}: ${response.statusText}`);
                //}
                
                //return response;
            //} catch (error) {
              //  console.error('Network error:', error);
                //throw error;
            //}
        //}
        async function apiRequest(url, method, data) {
    const headers = {
        'Content-Type': 'application/json'
    };
    
    try {
        const response = await fetch(url, {
            method,
            headers,
            body: data ? JSON.stringify(data) : null,
            credentials: 'include'  // WA呕NE: wysya cookies z 偶daniem
        });
        
        // Debug logging
        console.log(`${method} ${url} - Status: ${response.status}`);
        
        // Logowanie bd贸w
        if (!response.ok) {
            console.error(`API Error ${response.status}: ${response.statusText}`);
            const errorText = await response.text();
            console.error('Response:', errorText);
        }
        
        return response;
    } catch (error) {
        console.error('Network error:', error);
        throw error;
    }
}
        // Sprawd藕 status autoryzacji
        async function checkAuthStatus() {
            try {
                const response = await apiRequest('/api/auth/me', 'GET');
                if (response.ok) {
                    currentUser = await response.json();
                    updateUI();
                    loadPosts();
                } else {
                    currentUser = null;
                    updateUI();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                currentUser = null;
                updateUI();
            }
        }
        
        // Rejestracja
        async function register() {
            const data = {
                username: document.getElementById('reg_username').value,
                email: document.getElementById('reg_email').value,
                password: document.getElementById('reg_password').value
            };
            
            const response = await apiRequest('/api/auth/register', 'POST', data);
            const result = await response.json();
            
            if (response.ok) {
                showMessage('Rejestracja udana! Teraz si zaloguj.', 'success');
                document.getElementById('reg_errors').innerHTML = '';
                // Wyczy pola
                document.getElementById('reg_username').value = '';
                document.getElementById('reg_email').value = '';
                document.getElementById('reg_password').value = '';
                
                // Po rejestracji backend ustawia cookies, wic sprawd藕 status
                await checkAuthStatus();
            } else {
                document.getElementById('reg_errors').innerHTML = result.message || 'Bd rejestracji';
            }
        }
        
        // Logowanie
        async function login() {
            const data = {
                username: document.getElementById('login_username').value,
                password: document.getElementById('login_password').value
            };
            
            const response = await apiRequest('/api/auth/login', 'POST', data);
            const result = await response.json();
            
            if (response.ok) {
                showMessage('Zalogowano!', 'success');
                document.getElementById('login_errors').innerHTML = '';
                
                // Backend ustawia tokeny w cookies, wic odwie偶amy status
                await checkAuthStatus();
                
                // Wyczy pola
                document.getElementById('login_username').value = '';
                document.getElementById('login_password').value = '';
            } else {
                document.getElementById('login_errors').innerHTML = result.message || 'Bd logowania';
            }
        }
        
        // Wylogowanie
        async function logout() {
            try {
                const response = await apiRequest('/api/auth/logout', 'POST');
                if (response.ok) {
                    currentUser = null;
                    updateUI();
                    showMessage('Wylogowano.', 'success');
                    loadPosts();
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        
        // Formatowanie daty - POPRAWIONE konwersja strefy czasowej
        function formatDateTime(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                
                // Jeli data zawiera stref czasow UTC, konwertuj do lokalnej
                // Zamiast odejmowa offset, u偶yj toLocaleString z odpowiednimi opcjami
                const options = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false, // 24-godzinny format
                    timeZone: 'Europe/Warsaw' // Ustawienie na polsk stref czasow
                };
                
                return new Intl.DateTimeFormat('pl-PL', options).format(date);
            } catch (e) {
                console.error('Bd formatowania daty:', e, 'dateString:', dateString);
                return dateString;
            }
        }
        
        // Zaaduj posty
        async function loadPosts() {
            const response = await apiRequest('/api/posts', 'GET');
            if (response.ok) {
                const data = await response.json();
                displayPosts(data.posts || []);
            } else {
                document.getElementById('posts').innerHTML = '<p class="error">Bd adowania post贸w</p>';
            }
        }
        
        // Wywietl posty
        function displayPosts(posts) {
            const container = document.getElementById('posts');
            container.innerHTML = '<h3> Posty:</h3>';
            
            if (!posts || posts.length === 0) {
                container.innerHTML += '<p><em>Brak post贸w</em></p>';
                return;
            }
            
            posts.forEach(post => {
                const canDelete = currentUser && 
                    (currentUser.id === post.author_id || currentUser.role === 'ADMIN');
                
                container.innerHTML += `
                    <div class="post">
                        <h4>${post.title || 'Brak tytuu'}</h4>
                        <p>${post.content || ''}</p>
                        <small>Autor: ${post.author?.username || 'Unknown'} | 
                               Data: ${formatDateTime(post.created_at)}</small>
                        
                        ${canDelete ? `<button onclick="deletePost(${post.id})" style="background:#dc3545">Usu</button>` : ''}
                        
                        <!-- Sekcja komentarzy -->
                        <div id="comments_${post.id}">
                            <h5>Komentarze:</h5>
                            <div id="comments_list_${post.id}"></div>
                            
                            <!-- Formularz dodawania komentarza -->
                            ${currentUser ? `
                            <div class="comment-form">
                                <textarea id="comment_input_${post.id}" 
                                          placeholder="Napisz komentarz..." 
                                          rows="2"></textarea>
                                <button onclick="addComment(${post.id})">Dodaj komentarz</button>
                            </div>
                            ` : '<p><small>Zaloguj si, aby komentowa</small></p>'}
                        </div>
                    </div>
                `;
                
                // Zaaduj istniejce komentarze
                loadComments(post.id);
            });
        }
        
        // Utw贸rz post
        async function createPost() {
            const data = {
                title: document.getElementById('post_title').value,
                content: document.getElementById('post_content').value,
                is_published: true
            };
            
            const response = await apiRequest('/api/posts', 'POST', data);
            if (response.ok) {
                showMessage('Post utworzony!', 'success');
                document.getElementById('post_title').value = '';
                document.getElementById('post_content').value = '';
                loadPosts();
            } else {
                const error = await response.json();
                alert(error.message || 'Bd tworzenia posta');
            }
        }
        
        // Usu post
        async function deletePost(postId) {
            if (confirm('Czy na pewno usun ten post?')) {
                const response = await apiRequest(`/api/posts/${postId}`, 'DELETE');
                if (response.ok) {
                    showMessage('Post usunity!', 'success');
                    loadPosts();
                } else {
                    const error = await response.json();
                    alert(error.message || 'Bd usuwania posta');
                }
            }
        }
        
        // Dodaj komentarz
        async function addComment(postId) {
            const input = document.getElementById(`comment_input_${postId}`);
            const content = input.value.trim();
            
            if (!content || content.length < 2) {
                alert('Komentarz musi mie co najmniej 2 znaki');
                return;
            }
            
            const response = await apiRequest(`/api/posts/${postId}/comments`, 'POST', { content });
            
            if (response.ok) {
                const result = await response.json();
                showMessage('Komentarz dodany!', 'success');
                input.value = ''; // Wyczy pole
                loadComments(postId); // Przeaduj komentarze
            } else {
                const error = await response.json();
                alert(error.message || 'Bd dodawania komentarza');
            }
        }
        
        // Zaaduj komentarze
        async function loadComments(postId) {
            const response = await apiRequest(`/api/posts/${postId}/comments`, 'GET');
            
            if (response.ok) {
                const data = await response.json();
                const commentList = document.getElementById(`comments_list_${postId}`);
                
                if (data.comments && data.comments.length > 0) {
                    commentList.innerHTML = '';
                    data.comments.forEach(comment => {
                        // Poprawne formatowanie daty
                        const dateStr = formatDateTime(comment.created_at);
                        
                        commentList.innerHTML += `
                            <div class="comment">
                                <strong>${comment.author_username || 'Unknown'}:</strong> 
                                ${comment.content || ''}
                                <small>${dateStr}</small>
                            </div>
                        `;
                    });
                } else {
                    commentList.innerHTML = '<p><em>Brak komentarzy</em></p>';
                }
            }
        }
        
        // Aktualizuj UI
        function updateUI() {
            document.getElementById('logoutBtn').style.display = currentUser ? 'block' : 'none';
            document.getElementById('create_post').style.display = currentUser ? 'block' : 'none';
            document.getElementById('login_errors').innerHTML = '';
            
            if (currentUser) {
                document.getElementById('user_info').innerHTML = `
                    <p>Zalogowany jako: <strong>${currentUser.username}</strong> (${currentUser.role})</p>
                `;
            } else {
                document.getElementById('user_info').innerHTML = '';
            }
        }
        
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.innerHTML = `<div class="${type}">${text}</div>`;
            setTimeout(() => msgDiv.innerHTML = '', 5000);
        }
        
        // Zaaduj posty na start
        loadPosts();
    </script>
</body>
</html>